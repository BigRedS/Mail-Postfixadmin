#! /usr/bin/perl

use Vpostmail;
use strict;
use Getopt::Std;
my %opt;
my $domain = pop;
getopts('hU', \%opt);

if(exists($opt{h})){
        print usage();
        exit 0; 
}

if ($domain eq '' || $domain eq '-h' || exists($opt{h})){
	print usage();
	exit 1;
}

my $d = Vpostmail->new();

$d->setDomain($domain);

if ($d->domainExists){
	unless(exists($opt{U})){
		foreach($d->listUsers){
			print "removing $_ ";
			$d->setUser($_);
			if($d->removeUser){
				print "done\n"
			}else{
				print "ERROR: $d->{errstr}\n";
			}
		}
	}
	print "removing domain $domain ";
	$d->removeDomain();
}else{
	print STDERR "Domain $domain not found\n";
	exit 1
}

if ($d->domainExists){
	print STDERR "Error: I deleted it, but it's still there\n";
	exit 1;
}else{
	print "done\n";
}
exit 0;

sub usage {

return <<EOF;
vdeldomain

Deletes a domain from the mail system.

Usage:

  vdeldomain [options] <domain>

Returns 0 on success, 1 on any sort of failure.
EOF
}
